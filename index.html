<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
        <title>Anime Q&A</title>
        <link rel="icon" href="imgs/QA_icon.svg">

        <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>

        <script src="https://cdn.jsdelivr.net/npm/vue"></script>
        <script src="https://unpkg.com/vue-router"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/vue-resource/1.2.0/vue-resource.js"></script>
        <script src="https://unpkg.com/element-ui@2.6.1/lib/index.js"></script>
        <script src="https://unpkg.com/lodash@4.16.0"></script>
        <script src="https://cdn.jsdelivr.net/npm/axios@0.12.0/dist/axios.min.js"></script>

        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">

        <style>
            body {
                background-color: white;
                overflow-y: overlay;
            }
            h1 {
                font-size: 4.5vh;
                letter-spacing: 3px;
            }
            a {
                transition: all ease 0.3s;
            }
            a:hover {
                text-decoration: none;
            }
            #bg {
                z-index: -10;
                position: fixed;
                left: -5px;
                top: -5px;
                width: 135vw;
                height: 105vh;
                opacity: 0.5;
                background-image: url("./imgs/BG.png");
                background-position: center;
                background-repeat: no-repeat;
                background-size: cover;
                filter: blur(4px);
            }
            #main {
                font-size: 2vh;
                margin-top: 25vh;
                width: 100%;
                height: auto;
                transition: all ease 0.6s;
            }
            #main-container {
                background-color: white;
                border-radius: 1em;
                box-shadow: rgba(0, 0, 0, 0.2) 0.2em 0.2em 0.5em;
                max-width: 900px; 
                padding: 1.2em;
                margin: 2em auto;
                transition: all ease 0.5s;
            }
            #main-container:hover {
                transform: translateY(-10px);
                box-shadow: rgba(0, 0, 0, 0.3) 0.2em 0.1em 0.5em;
            }
            #heading {
                text-align: center; 
                font-weight: bold;
            }
            #tips {
                font-size: 1.8vh;
                text-align: center;
                margin: 1em;
                color: #008568;
            }
            #submit-btn {
                font-size: 2.1vh;
            }
            #q-input {
                font-size: 2.1vh;
            }
            #loading-icon {
                height: 2.4vh;
                width: 2.4vh;
            }
            #credits {
                width: 100%;
                margin-bottom: 2vh;
                text-align: center;
                font-size: 1.2vh;
                opacity: 0.5;
                transition: all ease 0.8s;
            }
            #credits:hover {
                opacity: 0.75;
            }
            #result {
                margin-top: 3vh;
                background-color: #e8f2ff;
                border-radius: 1vh!important;
            }
            #result-content {
                padding: 3vh;
                max-height: 12vh;
                overflow: hidden;
            }
            #more-less-switch {
                width: 100%;
                font-size: 1.8vh;
                border-radius: 0 0 1vh 1vh;
            }
            .tooltip-inner {
                font-size: 1.5vh;
                max-width: 63vw;
                width: 27em;
                text-align:left;
                padding: 0.6em;
            }
            .tooltip.show {
                opacity: 0.8!important;
                filter:alpha(opacity=80);
            }
        </style>
    </head>


    <body>
        <div id="bg"></div>
        <div id="main">
            <div ref="full">
                <div class="container-sm" id="main-container">
                    <h1 id="heading">äºŒåˆºèˆQ&A</h1>
                    <div id="tips">
                        æˆ‘èƒ½è¿™ä¹ˆé—® â†’ 
                        <span style="cursor: pointer;" :title="tip"
                              :style="is_mobile ? 'text-decoration: underline; font-weight: bold;' : ''" 
                              data-toggle="tooltip" data-placement="bottom" data-html="true">
                            {{is_mobile ? "ã€ç‚¹å‡»æŸ¥çœ‹ã€‘" : "âš ï¸"}}
                        </span>
                    </div>
                    <div class="form-group">
                        <input v-model="question" class="form-control" id="q-input">
                    </div>
                    <button @click="ask" class="btn btn-primary" style="width: 100%;" id="submit-btn">
                        <span v-if="loading">
                            <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true" id="loading-icon"></span>
                            {{loading_hint}}
                        </span>
                        <span v-else>
                            {{submit_text}}
                        </span>
                    </button>
                    <div class="collapse" id="result">
                        <div class="" id="result-content">
                            <div style="display: inline; line-height: 3vh;" ref="ans">
                                {{answer}}
                            </div>
                        </div>
                        <button @click="toggle_short"
                                :class=""
                                class="btn btn-secondary btn-sm"
                                id="more-less-switch"
                                v-show="is_long_ans">
                            {{show_full_ans ? "show less" : "show more"}}
                        </button>
                    </div>
                </div>  
                <div id="credits">
                    <div>å¼€å‘è€…ï¼šè´ºæ¢“æ·‡ã€æ›¾åšæ¶µã€ç‹æ–‡è¾‰</div>
                    <div><a href="https://github.com/APassbyDreg/AnimeKnowledgeGraph">[Source on GitHub]</a></div>
                </div>
            </div>
        </div>

        <script>
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
            var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl)
            })

            Vue.http.headers.common['Access-Control-Allow-Origin'] = '*';
            let vm = new Vue({
                el: "#main",
                data: {
                    question: "",
                    answer: "",
                    tip: "<div style='text-align:left'>ã€ç•ªå‰§ã€‘çš„ï¼ˆé…éŸ³æ¼”å‘˜/è§’è‰²ï¼‰éƒ½æœ‰å“ªäº›</br>ã€å£°ä¼˜ã€‘æ‹…å½“è¿‡ä»€ä¹ˆï¼ˆç•ªå‰§/è§’è‰²ï¼‰çš„é…éŸ³</br>ã€è§’è‰²ã€‘æ˜¯å“ªä¸ªç•ªå‰§é‡Œçš„è§’è‰²</br>ã€è§’è‰²ã€‘çš„é…éŸ³æ¼”å‘˜æ˜¯è°</br>ã€ç•ªå‰§ã€‘çš„ï¼ˆç”»é£/å‰§æƒ…/éŸ³ä¹ï¼‰æˆ‘å¾ˆå–œæ¬¢ï¼Œæœ‰ä»€ä¹ˆæ¨èå—</div>",
                    loading_hint: "åœ¨æƒ³äº†ï¼Œä½ æ€¥ä¸ªğŸ”¨",
                    submit_text: "ğŸ‘´å¾ˆå¥½å¥‡ï¼",
                    loading: false,
                    ask_cnt: 0,
                    show_full_ans: false,
                    is_long_ans: false
                },
                created: function () {
                    // `_.debounce` æ˜¯ä¸€ä¸ªé€šè¿‡ Lodash é™åˆ¶æ“ä½œé¢‘ç‡çš„å‡½æ•°ã€‚
                    // åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å¸Œæœ›é™åˆ¶è®¿é—® yesno.wtf/api çš„é¢‘ç‡
                    // AJAX è¯·æ±‚ç›´åˆ°ç”¨æˆ·è¾“å…¥å®Œæ¯•æ‰ä¼šå‘å‡ºã€‚æƒ³è¦äº†è§£æ›´å¤šå…³äº
                    // `_.debounce` å‡½æ•° (åŠå…¶è¿‘äº² `_.throttle`) çš„çŸ¥è¯†ï¼Œ
                    // è¯·å‚è€ƒï¼šhttps://lodash.com/docs#debounce
                    this.debouncedGetAnswer = _.debounce(() => {
                        $('.collapse').collapse("hide");
                        this.loading = true;
                        // wait till collapsed
                        setTimeout(() => { this.get_ans(); }, 250);
                    }, 500);
                },
                computed: {
                    is_mobile: function () {
                        let flag = navigator.userAgent.match(/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i)
                        return flag != null;
                    }
                },
                methods: {
                    ask: function() {
                        this.ask_cnt += 1;
                        if (this.ask_cnt > 3) {
                            this.loading_hint = "è¿˜é—®ï¼Ÿä½ ä¸ä¼šè‡ªä¸ªç™¾åº¦å—ğŸ™„";
                            this.submit_text = "ğŸ‘´å°±æ˜¯å¾ˆå¥½å¥‡ï¼";
                        }
                        this.debouncedGetAnswer();
                    },
                    get_ans: function () {
                        let url_cn = "https://1354839170291685.cn-beijing.fc.aliyuncs.com/2016-08-15/proxy/anime-knowledge-graph/anime-qa/?question="
                        this.$http.get(url_cn + encodeURIComponent(this.question)).then(res => {
                            if (res.body['success']) {
                                this.answer = res.body["result"];
                                $('.collapse').collapse("show");
                            }
                            else {
                                alert(res.body["result"]);
                            }
                            this.loading = false;
                        }, res => {
                            this.loading = false;
                            alert("error connection: status=" + res.status);
                        })
                    },
                    update_content_layout: function () {
                        // update content margin top
                        let h = this.$refs.full.clientHeight + "px";
                        document.getElementById("main").style.marginTop = "max(10vh, calc(90vh - " + h + "))";

                        // update is long ans
                        let ans_lines = this.count_ans_lines();
                        this.is_long_ans = ans_lines > 3;
                    },
                    toggle_short: function () {
                        this.show_full_ans = !this.show_full_ans;
                        if (this.show_full_ans) {
                            document.getElementById("result-content").style.maxHeight = "none";
                        }
                        else {
                            document.getElementById("result-content").style.maxHeight = "12vh";
                        }
                    },
                    count_ans_lines: function () {
                        let total_height = this.$refs.ans.offsetHeight;
                        let line_height = window.innerHeight * 0.03;
                        return Math.ceil(total_height / line_height);
                    }
                },
                mounted: function () {
                    setInterval(() => {
                        this.update_content_layout()
                    }, 100);
                }
            })

            $(document).ready(function() {
                $("body").tooltip({ selector: '[data-toggle=tooltip]' });
            });
        </script>
    </body>
</html>